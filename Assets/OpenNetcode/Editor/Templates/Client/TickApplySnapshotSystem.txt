using ExampleGame.Shared.Movement.Components;
using OpenNetcode.Client.Components;
using OpenNetcode.Shared.Systems;
using OpenNetcode.Shared.Time;
using Unity.Burst;
using Unity.Entities;
using UnityEngine;

namespace Client.Generated
{
    [UpdateInGroup(typeof(TickPreSimulationSystemGroup), OrderLast = true)]
    [DisableAutoCreation]
    public class TickApplySnapshotSystem : SystemBase
    {
        private TickSystem _tickSystem;
        
        //<template:publicsnapshot>
        //private EntityQuery _##TYPELOWER##Query;
        //</template>
        //<template:private>
        //private EntityQuery _##TYPELOWER##Query;
        //</template>

        protected override void OnCreate()
        {
            _tickSystem = World.GetExistingSystem<TickSystem>();
            
            //<template:publicsnapshot>
            //_entityPositionQuery = GetEntityQuery(
            //    ComponentType.Exclude<Prediction<##TYPE##>>(),
            //    ComponentType.ReadOnly<SnapshotBufferElement<##TYPE##>>(),
            //    ComponentType.ReadWrite<##TYPE##>());
            //</template>
            //<template:privatesnapshot>
            //ApplyFromBufferJob<##TYPE##> ##TYPELOWER##Job = new ApplyFromBufferJob<##TYPE##>()
            //{
            //    Tick = (int) tickFrom,
            //    BufferFromEntity = GetBufferTypeHandle<SnapshotBufferElement<##TYPE##>>(true),
            //    ComponentDataFromEntity = GetComponentTypeHandle<##TYPE##>()
            //};
            //Dependency = ##TYPELOWER##Job.ScheduleParallel(_##TYPELOWER##Query, Dependency);
            //</template>
            
            
            Dependency.Complete();
        }

        [BurstCompile]
        private struct ApplyFromBufferJob<T> : IJobChunk where T : unmanaged, IComponentData
        {
            public int Tick;
            public ComponentTypeHandle<T> ComponentDataFromEntity;
            public BufferTypeHandle<SnapshotBufferElement<T>> BufferFromEntity;
        
            public void Execute(ArchetypeChunk chunk, int chunkIndex, int firstEntityIndex)
            {
                var components = chunk.GetNativeArray(ComponentDataFromEntity);
                var buffers = chunk.GetBufferAccessor(BufferFromEntity);

                for (int i = 0; i < chunk.Count; i++)
                {
                    var buffer = buffers[i];
                    var element = buffer[Tick % TimeConfig.SnapshotsPerSecond];
                    if (element.Tick == Tick)
                    {
                        components[i] = element.Value;
                    }
                }
            }
        }
    }
}
